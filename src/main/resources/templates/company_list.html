<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Company List</title>
    <div th:replace="~{fragments/include :: include}"></div>
    <script th:src="@{/js/main.js}"></script>
</head>
<body>
    <div th:replace="~{fragments/header :: header}"></div>
    <main id="main" class="main">
        <div class="pagetitle">
            <nav>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/}"><i class="fa-solid fa-house"></i><span class="mx-1">Welcome</span></a></li>
                    <li class="breadcrumb-item"><a th:href="@{/api/company/}">Company</a></li>
                </ol>
            </nav>
        </div>

        <section class="section">
            <div class="row align-items-top">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">New/Update</h5>
                            <form th:object="${company}" id="submitForm" method="POST">
                                <div class="row mb-3">
                                    <label for="cityName" class="col-2 col-form-label">City Name</label>
                                    <div class="col-3" id="city-select">
                                        <select class="form-select" id="cityName" th:field="*{cityName}">
                                            <option value="" selected>--- Choose ---</option>
                                            <option th:each="c : ${cityList}" th:text="${c.name}" th:value="${c.name}"></option>
                                        </select>
                                        <span class="text-small text-danger" th:if="${#fields.hasErrors('cityName')}" th:errors="*{cityName}"></span>
                                    </div>
                                    <label for="townshipName" class="col-2 col-form-label">Township Name</label>
                                    <div class="col-3" id="township-select">
                                        <select class="form-select" id="townshipName" th:field="*{townshipName}">
                                            <option value="" selected>--- Choose ---</option>
                                        </select>
                                        <span class="text-small text-danger" th:if="${#fields.hasErrors('townshipName')}" th:errors="*{townshipName}"></span>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label for="industrialZoneName" class="col-2 col-form-label">Industrial Zone Name</label>
                                    <div class="col-3" id="industrial-zone-select">
                                        <select class="form-select" id="industrialZoneName" th:field="*{industrialZoneName}">
                                            <option value="" selected>--- Choose ---</option>
                                        </select>
                                        <span class="text-small text-danger" th:if="${#fields.hasErrors('industrialZoneName')}" th:errors="*{industrialZoneName}"></span>
                                    </div>
                                    <label for="companyName" class="col-2 col-form-label">Company Name</label>
                                    <div class="col-3">
                                        <input type="text" class="form-control" id="companyName" th:field="*{name}">
                                        <span class="text-small text-danger" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></span>
                                    </div>
                                </div>
                                <div style="float: right; margin-top: 20px">
                                    <button type="submit" class="btn btn-add" style="background:#49b7bf; color:white;">Add</button>
                                    <button type="submit" class="btn btn-update mx-2" style="background:#49b7bf; color:white;" disabled>Update</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title text-danger" th:if="${companyList.isEmpty()}">No record found!</h5>
                            <h5 class="card-title">Company List</h5>
                            <hr>
                            <form th:action="@{/api/company/page}" id="searchForm" class="mt-4">
                                <div class="row mb-4">
                                    <label for="citySearch" class="col-2 col-form-label">City Name</label>
                                    <div class="col-3">
                                        <select class="form-select" id="citySearch" name="cityName">
                                            <option value="" selected>-- Choose for Searching --</option>
                                            <option th:each="c : ${cityList}" th:text="${c.name}" th:value="${c.name}" th:selected="${c.name == cityName}"></option>
                                        </select>
                                    </div>
                                    <label for="townshipSearch" class="col-2 col-form-label">Township Name</label>
                                    <div class="col-3">
                                        <select class="form-select" id="townshipSearch" name="townshipName">
                                            <option value="" selected>-- Choose for Searching --</option>
                                            <option th:each="t : ${townshipList}" th:text="${t.name}" th:value="${t.name}" th:selected="${t.name == townshipName}"></option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-4">
                                    <label for="industrialZoneSearch" class="col-2 col-form-label">Industrial Zone Name</label>
                                    <div class="col-3">
                                        <select class="form-select" id="industrialZoneSearch" name="industrialZoneName">
                                            <option value="" selected>-- Choose for Searching --</option>
                                            <option th:each="i : ${industrialZoneList}" th:text="${i.name}" th:value="${i.name}" th:selected="${i.name == industrialZoneName}"></option>
                                        </select>
                                    </div>
                                    <div class="col-5">
                                        <div class="input-group">
                                            <input id="keyword" type="search" name="keyword" th:value="${keyword}" class="form-control" placeholder="&#128269; Search by company name">
                                            <button type="submit" class="btn" style="background:#49b7bf; color:white; margin-right: 20px">Search</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <label class="form-label" for="pageSize">Items per page:</label>
                                    <select name="size" th:value="${pageSize}" onchange="this.form.submit()" class="form-select" id="pageSize" style="width: auto; margin-left: 20px; margin-right: 20px; display: inline">
                                        <option th:each="s : ${ {5, 10, 15} }" th:value="${s}" th:text="${s}" th:selected="${s == pageSize}"></option>
                                    </select>
                                    <button id="btnClear" class="btn" style="background:#f56e70; color:white;">Clear</button>
                                </div>
                            </form>
                            <hr>
                            <table class="table table-bordered" style="margin-top: 40px" th:if="${totalPages > 0}">
                                <thead>
                                <tr style="background:#f5f7f6;">
                                    <th>#</th>
                                    <th>Company Name</th>
                                    <th>City Name</th>
                                    <th>Township Name</th>
                                    <th>Industrial Zone Name</th>
                                    <th>Action</th>
                                    <th>Status</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="company, state : ${companyList}">
                                    <td th:text="${company.id}" hidden></td>
                                    <td th:text="${pageSize * (currentPage - 1) + state.index + 1}"></td>
                                    <td th:text="${company.name}"></td>
                                    <td th:text="${company.industrialZone.township.city.name}"></td>
                                    <td th:text="${company.industrialZone.township.name}"></td>
                                    <td th:text="${company.industrialZone.name}"></td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-edit">Edit</button>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input status" type="checkbox" role="switch" th:checked="${company.activeStatus}">
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <span th:if="${totalPages > 0}">Showing [[${pageSize * (currentPage - 1) + 1}]] to [[${pageSize * (currentPage - 1) + pageSize}]] of Total [[${totalItems}]] Entries</span>
                            <div th:replace="~{fragments/paging :: companyPagination}"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main><!-- End #main -->
    <!-- ======= Footer ======= -->
    <footer id="footer" class="footer">
    </footer><!-- End Footer -->
    <script th:inline="javascript">

        $(document).ready(function() {
        <!-- Search Boxes in Select Box -->
            var cityName = document.querySelector("#cityName");
            var citySearch = document.querySelector("#citySearch");
            var townshipName = document.querySelector("#townshipName");
            var townshipSearch = document.querySelector("#townshipSearch");
            var industrialZoneName = document.querySelector("#industrialZoneName");
            var industrialZoneSearch = document.querySelector("#industrialZoneSearch");
            dselect(cityName, {search: true});
            dselect(citySearch, {search: true});
            dselect(townshipName, {search: true});
            dselect(townshipSearch, {search: true});
            dselect(industrialZoneName, {search: true});
            dselect(industrialZoneSearch, {search: true});
        <!-- End -->

        <!-- When page is returned with error message for automatically choosing select boxes -->
            var city_name = $("#cityName option:selected").val();
            setTimeout(function() {
                $.ajax({
                    url: "/api/company/cityToTownship",
                    type: "POST",
                    data: {
                        "cityName" : city_name
                    },
                    success: function(data) {
                        $("#townshipName option[value!='']").remove();

                        if(data.length != 0) {
                            for(var i = 0; i < data.length; i++) {
                                $("#townshipName").append(`<option value="${data[i].name}">${data[i].name}</option>`);
                            }

                            dselect(townshipName, {search: true});
                            $("#submitForm .row #township-select .dselect-wrapper .dropdown-menu .d-flex .dselect-items button:contains(" + [[${township_select}]] + ")").click();
                        }

                        setTimeout(function() {
                            $.ajax({
                                url: "/api/company/townshipToIndustrialZone",
                                type: "POST",
                                data: {
                                    "townshipName" : [[${township_select}]]
                                },
                                success: function(data) {
                                    $("#industrialZoneName option[value!='']").remove();

                                    if(data.length != 0) {
                                        for(var i = 0; i < data.length; i++) {
                                            $("#industrialZoneName").append(`<option value="${data[i].name}">${data[i].name}</option>`);
                                        }

                                        dselect(industrialZoneName, {search: true});
                                        $("#submitForm .row #industrial-zone-select .dselect-wrapper .dropdown-menu .d-flex .dselect-items button:contains(" + [[${industrial_zone_select}]] + ")").click();
                                        $("#companyName").focus();
                                    }
                                }
                            });
                        }, 100);
                    }
                });
            }, 100);

        <!-- End -->

        <!-- Alert Boxes -->
            if([[${added_success}]]) {
                iziToast.success({
                    message: 'Successfully Added!',
                    position: 'topCenter'
                });
            }

            if([[${updated_success}]]) {
                iziToast.success({
                    color: 'blue',
                    message: 'Successfully Updated!',
                    position: 'topCenter'
                });
            }

            if([[${active_status_success}]]) {
                iziToast.success({
                    message: 'This company is active now!',
                    position: 'topCenter'
                });
            }

            if([[${inactive_status_success}]]) {
                iziToast.warning({
                    message: 'This company is inactive now!',
                    position: 'topCenter'
                });
            }

            if([[${company_not_found}]]) {
                iziToast.error({
                    color: 'red',
                    title: 'Failed!',
                    message: 'This company is not found!',
                    position: 'topCenter'
                });
            }
        <!-- End -->

        <!-- When add button is clicked -->
            $(".btn-add").click(function(event) {
                event.preventDefault();

                $.confirm({
                    title: 'Confirm!',
                    content: 'Are you sure to add?',
                    type: 'green',
                    autoClose: 'no|10000',
                    buttons: {
                        yes: {
                            btnClass: 'btn-success',
                            action: function () {
                                $("#submitForm").prop("action", "/api/company/add");
                                $("#submitForm").submit();
                            }
                        },
                        no: function () {}
                    }
                });
            });
        <!-- End -->

        <!-- When edit button is clicked -->
            $(document).delegate(".btn-edit", "click", function(event) {
                var parent = $(this).parent().parent().parent();
                var id = parent.children("td:nth-child(1)").html();
                var company_name = parent.children("td:nth-child(3)").html();
                var city_name = parent.children("td:nth-child(4)").html();
                var township_name = parent.children("td:nth-child(5)").html();
                var industrial_zone_name = parent.children("td:nth-child(6)").html();

                $("#companyName").val(company_name);
                $("#submitForm .row #city-select .dselect-wrapper .dropdown-menu .d-flex .dselect-items button:contains(" + city_name + ")").click();

                setTimeout(function() {
                    $.ajax({
                        url: "/api/company/cityToTownship",
                        type: "POST",
                        data: {
                            "cityName" : city_name
                        },
                        success: function(data) {
                            $("#townshipName option[value!='']").remove();

                            if(data.length != 0) {
                                for(var i = 0; i < data.length; i++) {
                                    $("#townshipName").append(`<option value="${data[i].name}">${data[i].name}</option>`);
                                }

                                dselect(townshipName, {search: true});
                                $("#submitForm .row #township-select .dselect-wrapper .dropdown-menu .d-flex .dselect-items button:contains(" + township_name + ")").click();
                            }

                            setTimeout(function() {
                                $.ajax({
                                    url: "/api/company/townshipToIndustrialZone",
                                    type: "POST",
                                    data: {
                                        "townshipName" : township_name
                                    },
                                    success: function(data) {
                                        $("#industrialZoneName option[value!='']").remove();

                                        if(data.length != 0) {
                                            for(var i = 0; i < data.length; i++) {
                                                $("#industrialZoneName").append(`<option value="${data[i].name}">${data[i].name}</option>`);
                                            }

                                            dselect(industrialZoneName, {search: true});
                                            $("#submitForm .row #industrial-zone-select .dselect-wrapper .dropdown-menu .d-flex .dselect-items button:contains(" + industrial_zone_name + ")").click();
                                            $("#companyName").focus();
                                        }
                                    }
                                });
                            }, 100);
                        }
                    });
                }, 100);

                $(".btn-update").prop("disabled", false);
                $(".btn-update").append("<span hidden>" + id + "</span>");
            });
        <!-- End -->

        <!-- When update button is clicked -->
            $(".btn-update").click(function() {
                event.preventDefault();

                $.confirm({
                    title: 'Confirm!',
                    content: 'Are you sure to update?',
                    type: 'blue',
                    autoClose: 'no|10000',
                    buttons: {
                        yes: {
                            btnClass: 'btn-info text-white',
                            action: function () {
                                var id = $(".btn-update").children("span").html();
                                $("#submitForm").prop("action", "/api/company/update/" + id);
                                $("#submitForm").submit();
                            }
                        },
                        no: function () {}
                    }
                });
            });
        <!-- End -->

        <!-- When status button is clicked -->
            $(document).delegate(".status", "change", function() {
                var parent = $(this).parent().parent().parent();
                var id = parent.children("td:nth-child(1)").html();

                if($(this).is(':checked')) {
                    window.location = "/api/company/status/1/" + id;
                }
                else {
                    window.location = "/api/company/status/0/" + id;
                }
            });
        <!-- End -->

        <!-- When clear button is clicked -->
            $("#btnClear").on("click", function(e) {
              e.preventDefault();
              window.location = "/api/company/";
            });
        <!-- End -->

        <!-- When city select box is changed -->
            $("#cityName").change(function() {
                var city_name = $("#cityName option:selected").text();

                $.ajax({
                    url: "/api/company/cityToTownship",
                    type: "POST",
                    data: {
                        "cityName" : city_name
                    },
                    success: function(data) {
                        $("#townshipName option[value!='']").remove();

                        if(data.length != 0) {
                            for(var i = 0; i < data.length; i++) {
                                $("#townshipName").append(`<option value="${data[i].name}">${data[i].name}</option>`);
                            }

                            dselect(townshipName, {search: true});
                        }
                        else {
                            dselect(townshipName, {search: true});
                            $("#industrialZoneName option[value!='']").remove();
                            dselect(industrialZoneName, {search: true});
                        }
                    }
                });
            });
        <!-- End -->

        <!-- When township select box is changed -->
            $("#townshipName").change(function() {
                var township_name = $("#townshipName option:selected").text();

                $.ajax({
                    url: "/api/company/townshipToIndustrialZone",
                    type: "POST",
                    data: {
                        "townshipName" : township_name
                    },
                    success: function(data) {
                        $("#industrialZoneName option[value!='']").remove();

                        if(data.length != 0) {
                            for(var i = 0; i < data.length; i++) {
                                $("#industrialZoneName").append(`<option value="${data[i].name}">${data[i].name}</option>`);
                            }

                            dselect(industrialZoneName, {search: true});
                            $("#companyName").focus();
                        }
                        else {
                            dselect(industrialZoneName, {search: true});
                        }
                    }
                });
            });
        <!-- End -->

        });

    </script>
</body>
</html>